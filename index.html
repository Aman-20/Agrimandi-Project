<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriMandi Connect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem 2rem;
        }

        .card {
            background-color: #fff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
            outline: none;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 2rem;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 0.75rem;
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .clickable-tile {
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .clickable-tile:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        /* Carousel Styles */
        .carousel-item {
            display: none;
            transition: opacity 0.7s ease-in-out;
        }

        .carousel-item.active {
            display: block;
        }

        .toast {
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.5s ease-in-out;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.success {
            background-color: #28a745;
        }

        .toast.error {
            background-color: #dc3545;
        }
    </style>
</head>

<body class="bg-gray-100">
    <div id="notification-container" class="fixed top-5 right-5 z-[1100] space-y-2"></div>

    <div id="app" class="flex flex-col min-h-screen">
        <!--nav bar-->
        <nav class="bg-white shadow-md py-4 sticky top-0 z-50">
            <div class="container flex justify-between items-center flex-wrap">
                <div class="text-2xl font-bold text-green-700">AgriMandi Connect</div>
                <!-- NEW: Full Navigation Links -->
                <div id="main-nav-links" class="flex items-center space-x-4 text-gray-600 font-medium">
                </div>

                <div class="flex items-center space-x-4">
                    <div id="auth-links"></div>
                    <select id="language-switcher" class="form-input w-auto text-sm py-1 px-2">
                        <option value="en">English</option>
                        <option value="hi">हिन्दी</option>
                    </select>
                </div>
            </div>
        </nav>

        <main class="flex-grow">
            <section id="page-home" class="page-content">
                <!-- 1. Image Carousel -->
                <div id="image-carousel" class="relative w-full h-96 overflow-hidden shadow-lg">
                    <div class="carousel-item active">
                        <img src="https://res.cloudinary.com/dp55vvd7j/image/upload/v1758301493/farmer-banner_im2nez.jpg"
                            class="w-full h-full object-cover">
                    </div>
                    <div class="carousel-item">
                        <img src="https://res.cloudinary.com/dp55vvd7j/image/upload/v1758301491/Template-landscape-of-agriculture-and-farming-on-banner-8-large_rpvtor.jpg"
                            class="w-full h-full object-cover">
                    </div>
                    <div class="carousel-item">
                        <img src="https://res.cloudinary.com/dp55vvd7j/image/upload/v1758301487/image1_ttsey7.webp"
                            class="w-full h-full object-cover">
                    </div>
                    <!-- Carousel Controls -->
                    <button id="prev-btn"
                        class="absolute top-1/2 left-4 transform -translate-y-1/2 bg-white/70 rounded-full p-2 hover:bg-white">&lt;</button>
                    <button id="next-btn"
                        class="absolute top-1/2 right-4 transform -translate-y-1/2 bg-white/70 rounded-full p-2 hover:bg-white">&gt;</button>
                </div>

                <!--pages tiles-->
                <div class="container py-8">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-6 text-center">
                        <div data-page="mandi" class="nav-btn card clickable-tile cursor-pointer bg-green-50">
                            <h3 class="font-bold text-xl text-green-800" data-translate="nav_mandi">Mandi Prices</h3>
                        </div>
                        <div data-page="buyer" class="nav-btn card clickable-tile cursor-pointer bg-blue-50">
                            <h3 class="font-bold text-xl text-blue-800" data-translate="nav_buyer">Buyer Connect</h3>
                        </div>
                        <div data-page="advisory" class="nav-btn card clickable-tile cursor-pointer bg-yellow-50">
                            <h3 class="font-bold text-xl text-yellow-800" data-translate="nav_advisory">Advisory</h3>
                        </div>
                        <div data-page="schemes" class="nav-btn card clickable-tile cursor-pointer bg-red-50">
                            <h3 class="font-bold text-xl text-red-800" data-translate="nav_schemes">Schemes</h3>
                        </div>
                    </div>
                </div>

                <!--weather-->
                <div class="container grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="md:col-span-2 card bg-sky-100">
                        <h2 id="weather-location" class="text-2xl font-bold text-sky-800 mb-4">Fetching weather...</h2>
                        <div id="weather-content" class="flex items-center justify-around text-center">
                        </div>
                        <div id="weather-error" class="text-center text-red-600 hidden">
                            Could not fetch weather data. Please enable location services.
                        </div>
                    </div>

                    <div class="card bg-lime-100">
                        <h2 class="text-2xl font-bold text-lime-800 mb-2" data-translate="quick_tip_title">Quick Tip
                        </h2>
                        <p class="text-gray-700">•Best Practices for Harvesting Kharif Paddy (Rice)</p>
                        <p class="text-gray-700">•Prepare Your Fields for Rabi Season (Wheat & Mustard)</p>
                        <p class="text-gray-700">•Critical Pest Alert: Managing Gundhi Bug in Mature Paddy</p>
                    </div>
                </div>

                <!--Agriculture News-->
                <div class="container py-8">
                    <div class="card">
                        <h2 class="text-2xl font-bold text-gray-800 mb-6" data-translate="news_title">Latest Agriculture
                            News</h2>
                        <div id="news-container" class="space-y-4"></div>
                    </div>
                </div>
            </section>

            <section id="page-mandi" class="page-content container py-8 hidden">
                <div class="card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6" data-translate="mandi_title">Daily Mandi Prices
                    </h2>
                    <div class="flex flex-col md:flex-row gap-4 mb-6">
                        <div class="flex-1">
                            <label for="mandi-state" class="block text-gray-700 font-medium mb-1"
                                data-translate="label_state">State</label>
                            <select id="mandi-state" class="form-input"></select>
                        </div>
                        <div class="flex-1">
                            <label for="mandi-crop" class="block text-gray-700 font-medium mb-1"
                                data-translate="label_crop">Crop</label>
                            <select id="mandi-crop" class="form-input"></select>
                        </div>
                    </div>
                    <table class="min-w-full bg-white border border-gray-200">
                        <thead>
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Crop</th>
                                <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Price
                                    (₹/Quintal)</th>
                            </tr>
                        </thead>
                        <tbody id="mandi-data-body"></tbody>
                    </table>
                    <div id="admin-price-update-section" class="mt-8 border-t pt-6 hidden">
                        <h3 class="text-xl font-semibold mb-4 text-red-700">Admin: Update Crop Price</h3>
                        <form id="update-price-form" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <div>
                                <label for="update-state" class="block text-gray-700 font-medium">State</label>
                                <select id="update-state" class="form-input" required></select>
                            </div>
                            <div>
                                <label for="update-crop" class="block text-gray-700 font-medium">Crop</label>
                                <select id="update-crop" class="form-input" required>
                                    <option value="">-- Select a state first --</option>
                                </select>
                            </div>
                            <div>
                                <label for="update-price" class="block text-gray-700 font-medium">New Price</label>
                                <input type="number" id="update-price" class="form-input" required>
                            </div>
                            <button type="submit"
                                class="w-full bg-red-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-red-700">Update</button>
                        </form>
                    </div>
                </div>
            </section>

            <section id="page-advisory" class="page-content container py-8 hidden">
                <div class="card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Crop Advisory & Tips</h2>
                    <div id="advisory-container" class="space-y-6"></div>
                </div>
            </section>

            <section id="page-schemes" class="page-content container py-8 hidden">
                <div class="card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Government Schemes for Farmers</h2>
                    <div id="schemes-container" class="space-y-6"></div>

                </div>
            </section>

            <section id="page-buyer" class="page-content container py-8 hidden">
                <div class="card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Buyer & Farmer Connect</h2>

                    <div class="border-b border-gray-200 mb-6">
                        <nav class="flex space-x-4" aria-label="Tabs">
                            <button id="tab-buyer-requests"
                                class="tab-btn px-3 py-2 font-medium text-lg rounded-t-lg border-b-2 border-green-600 text-green-600">Buyers
                                Are Seeking</button>
                            <button id="tab-farmer-listings"
                                class="tab-btn px-3 py-2 font-medium text-lg text-gray-500 hover:text-gray-700">Farmers
                                Are Selling</button>
                        </nav>
                    </div>

                    <div id="content-buyer-requests" class="tab-content">
                        <div id="buyer-form-section" class="hidden">
                            <form id="buyer-form" class="space-y-4 mb-8 border-b pb-8">
                                <h3 class="text-xl font-semibold">Post a New Request</h3>
                                <div>
                                    <label for="buyer-crop-input" class="block text-gray-700 font-medium">Crop You
                                        Need</label>
                                    <input type="text" id="buyer-crop-input" class="form-input" required>
                                </div>
                                <div>
                                    <label for="buyer-quantity-input" class="block text-gray-700 font-medium">Quantity
                                        (in quintals)</label>
                                    <input type="number" id="buyer-quantity-input" class="form-input" required>
                                </div>
                                <div>
                                    <label for="buyer-contact-input" class="block text-gray-700 font-medium">Your
                                        Contact Number</label>
                                    <input type="tel" id="buyer-contact-input" class="form-input"
                                        placeholder="e.g., 9876543210" required>
                                </div>
                                <button type="submit"
                                    class="w-full bg-green-600 text-white font-semibold py-3 rounded-lg hover:bg-green-700">Submit
                                    Request</button>
                            </form>
                        </div>
                        <div id="buyer-login-prompt" class="text-center p-4 bg-yellow-100 rounded-lg mb-6">
                            <p>Please log in as a buyer to post a new request.</p>
                        </div>
                        <div id="buyer-requests" class="space-y-4"></div>
                    </div>

                    <div id="content-farmer-listings" class="tab-content hidden">
                        <div id="farmer-form-section" class="hidden">
                            <form id="farmer-form" class="space-y-4 mb-8 border-b pb-8">
                                <h3 class="text-xl font-semibold">Post Your Available Produce</h3>
                                <div>
                                    <label for="farmer-crop-input" class="block text-gray-700 font-medium">Crop You Are
                                        Selling</label>
                                    <input type="text" id="farmer-crop-input" class="form-input" required>
                                </div>
                                <div>
                                    <label for="farmer-quantity-input" class="block text-gray-700 font-medium">Quantity
                                        Available (in quintals)</label>
                                    <input type="number" id="farmer-quantity-input" class="form-input" required>
                                </div>
                                <div>
                                    <label for="farmer-price-input" class="block text-gray-700 font-medium">Price (per
                                        quintal)</label>
                                    <input type="number" id="farmer-price-input" class="form-input"
                                        placeholder="e.g., 2200" required>
                                </div>
                                <div>
                                    <label for="farmer-contact-input" class="block text-gray-700 font-medium">Your
                                        Contact Number</label>
                                    <input type="tel" id="farmer-contact-input" class="form-input" required>
                                </div>
                                <button type="submit"
                                    class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg hover:bg-blue-700">Submit
                                    Listing</button>
                            </form>
                        </div>
                        <div id="farmer-login-prompt" class="text-center p-4 bg-yellow-100 rounded-lg mb-6">
                            <p>Please log in as a farmer to post your produce.</p>
                        </div>
                        <div id="farmer-listings" class="space-y-4"></div>
                    </div>
                </div>
            </section>

            <section id="page-admin" class="page-content container py-8 hidden">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Admin Panel</h1>
                <div class="card mb-8">
                    <h2 class="text-2xl font-semibold mb-4">Manage News</h2>
                    <form id="add-news-form" class="space-y-4 mb-6 border-b pb-6">
                        <input type="text" id="news-headline" placeholder="Headline" class="form-input" required>
                        <textarea id="news-subtopic" placeholder="Subtopic/Description" class="form-input"
                            required></textarea>
                        <input type="url" id="news-link" placeholder="https://example.com/full-story" class="form-input"
                            required>
                        <button type="submit"
                            class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Add
                            News</button>
                    </form>
                    <div id="admin-news-list" class="space-y-2"></div>
                </div>
                <div class="card mb-8">
                    <h2 class="text-2xl font-semibold mb-4">Manage Schemes</h2>
                    <form id="add-scheme-form" class="space-y-4 mb-6 border-b pb-6">
                        <input type="text" id="scheme-title" placeholder="Scheme Title" class="form-input" required>
                        <textarea id="scheme-description" placeholder="Description" class="form-input"
                            required></textarea>
                        <input type="url" id="scheme-link" placeholder="https://example.gov.in/scheme"
                            class="form-input">
                        <button type="submit"
                            class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Add
                            Scheme</button>
                    </form>
                    <div id="admin-schemes-list" class="space-y-2"></div>
                </div>
                <div class="card">
                    <h2 class="text-2xl font-semibold mb-4">Manage Advisory Tips</h2>
                    <form id="add-advisory-form" class="space-y-4 mb-6 border-b pb-6">
                        <input type="text" id="advisory-title" placeholder="Tip Title" class="form-input" required>
                        <textarea id="advisory-description" placeholder="Description" class="form-input"
                            required></textarea>
                        <button type="submit"
                            class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Add
                            Advisory Tip</button>
                    </form>
                    <div id="admin-advisory-list" class="space-y-2"></div>
                </div>
            </section>

            <section id="page-my-posts" class="page-content container py-8 hidden">
                <div class="card">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">My Posts</h2>
                    <div id="my-posts-container" class="space-y-4">
                    </div>
                </div>
            </section>

        </main>

        <footer class="bg-gray-800 text-white py-8 mt-auto">
            <div class="container text-center">
                <p>&copy; 2025 AgriMandi Connect. All Rights Reserved.</p>
            </div>
        </footer>

        <div id="login-modal" class="modal">
            <div class="modal-content">
                <span class="close-btn" data-modal="login-modal">&times;</span>
                <h2 class="text-2xl font-bold mb-4">Login</h2>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-email" class="block text-gray-700">Email</label>
                        <input type="email" id="login-email" class="form-input" required>
                    </div>
                    <div class="mb-4">
                        <label for="login-password" class="block text-gray-700">Password</label>
                        <input type="password" id="login-password" class="form-input" required>
                    </div>
                    <button type="submit" id="login-submit-btn"
                        class="w-full bg-green-600 text-white py-2 rounded-lg">Login</button>
                    <p class="text-center text-sm mt-4">Don't have an account? <a href="#" id="show-register-link"
                            class="text-blue-600">Register here</a></p>
                </form>
            </div>
        </div>

        <div id="register-modal" class="modal">
            <div class="modal-content">
                <span class="close-btn" data-modal="register-modal">&times;</span>
                <h2 class="text-2xl font-bold mb-4">Register</h2>
                <form id="register-form">
                    <div class="mb-4">
                        <label for="register-name">Full Name</label>
                        <input type="text" id="register-name" class="form-input" required>
                    </div>
                    <div class="mb-4">
                        <label for="register-email">Email</label>
                        <input type="email" id="register-email" class="form-input" required>
                    </div>
                    <div class="mb-4">
                        <label for="register-password">Password</label>
                        <input type="password" id="register-password" class="form-input" required>
                    </div>
                    <div class="mb-4">
                        <label for="register-role">I am a:</label>
                        <select id="register-role" class="form-input" required>
                            <option value="">-- Select Role --</option>
                            <option value="farmer">Farmer</option>
                            <option value="buyer">Buyer</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-lg">Register</button>
                    <p class="text-center text-sm mt-4">Already have an account? <a href="#" id="show-login-link"
                            class="text-blue-600">Login here</a></p>
                </form>
            </div>
        </div>

        <div id="confirm-modal" class="modal">
            <div class="modal-content">
                <h2 class="text-2xl font-bold mb-4">Confirmation</h2>
                <p id="confirm-message" class="mb-6 text-gray-700"></p>
                <div class="flex justify-end space-x-4">
                    <button id="confirm-no-btn"
                        class="px-6 py-2 rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300">Cancel</button>
                    <button id="confirm-yes-btn"
                        class="px-6 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700">Confirm</button>
                </div>
            </div>
        </div>

    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let currentUser = null;
            let allMandiData = [];
            const pages = document.querySelectorAll('.page-content');
            //const navButtons = document.querySelectorAll('.nav-btn');
            const authLinksContainer = document.getElementById('auth-links');
            const mainNavLinks = document.getElementById('main-nav-links');
            const indianStates = ["Andhra Pradesh", "Arunachal Pradesh", "Assam", "Bihar", "Chhattisgarh", "Goa", "Gujarat", "Haryana", "Himachal Pradesh", "Jharkhand", "Karnataka", "Kerala", "Madhya Pradesh", "Maharashtra", "Manipur", "Meghalaya", "Mizoram", "Nagaland", "Odisha", "Punjab", "Rajasthan", "Sikkim", "Tamil Nadu", "Telangana", "Tripura", "Uttar Pradesh", "Uttarakhand", "West Bengal"];

            // --- NEW: Translations Object ---
            const translations = {
                en: {
                    nav_home: "Home", nav_mandi: "Mandi Prices", nav_buyer: "Buyer Connect", nav_advisory: "Advisory", nav_schemes: "Schemes",
                    quick_tip_title: "Quick Tip",
                    news_title: "Latest Agriculture News", welcome_user: "Welcome"
                },
                hi: {
                    nav_home: "होम", nav_mandi: "मंडी मूल्य", nav_buyer: "क्रेता कनेक्ट", nav_advisory: "सलाह", nav_schemes: "योजनाएं",
                    quick_tip_title: "त्वरित सुझाव",
                    news_title: "नवीनतम कृषि समाचार", welcome_user: "आपका स्वागत है"
                }
            };


            //--- show notification ---
            // ADD THIS NEW FUNCTION anywhere in your main script
            const showNotification = (message, type = 'success') => {
                const container = document.getElementById('notification-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                container.appendChild(toast);

                // Animate in
                setTimeout(() => {
                    toast.classList.add('show');
                }, 100);

                // Animate out and remove after 3 seconds
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, 3000);
            };


            // ADD THIS NEW FUNCTION to your script
            const showConfirmationModal = (message, onConfirm) => {
                const modal = document.getElementById('confirm-modal');
                document.getElementById('confirm-message').textContent = message;

                const yesBtn = document.getElementById('confirm-yes-btn');
                const noBtn = document.getElementById('confirm-no-btn');

                // Clone the button to remove old event listeners - this is a crucial step
                const newYesBtn = yesBtn.cloneNode(true);
                yesBtn.parentNode.replaceChild(newYesBtn, yesBtn);

                const close = () => modal.style.display = 'none';

                newYesBtn.onclick = () => {
                    close();
                    onConfirm(); // Execute the action
                };

                noBtn.onclick = close;

                modal.style.display = 'block';
            };

            // --- NEW: Language Switcher Logic ---
            const languageSwitcher = document.getElementById('language-switcher');
            const setLanguage = (lang) => {
                document.querySelectorAll('[data-translate]').forEach(el => {
                    const key = el.dataset.translate;
                    el.textContent = translations[lang][key] || el.textContent;
                });
                // Also update dynamic welcome message
                //updateUIForAuthState();
            };
            languageSwitcher.addEventListener('change', (e) => setLanguage(e.target.value));


            const showPage = (pageId) => {
                pages.forEach(page => page.classList.add('hidden'));
                const pageToShow = document.getElementById(`page-${pageId}`);
                if (pageToShow) {
                    pageToShow.classList.remove('hidden');
                }
                window.scrollTo(0, 0);
            };



            const openModal = (modalId) => document.getElementById(modalId).style.display = 'block';
            const closeModal = (modalId) => document.getElementById(modalId).style.display = 'none';

            document.querySelectorAll('.close-btn').forEach(btn => btn.addEventListener('click', () => closeModal(btn.dataset.modal)));
            document.getElementById('show-register-link').addEventListener('click', (e) => { e.preventDefault(); closeModal('login-modal'); openModal('register-modal'); });
            document.getElementById('show-login-link').addEventListener('click', (e) => { e.preventDefault(); closeModal('register-modal'); openModal('login-modal'); });

            // REPLACE your old updateUIForAuthState function with this one
            const updateUIForAuthState = () => {
                // --- 1. Build the entire navigation string first, based on login status ---
                let navHTML = `
        <button data-page="home" class="nav-btn hover:text-green-700" data-translate="nav_home">Home</button>
        <button data-page="mandi" class="nav-btn hover:text-green-700" data-translate="nav_mandi">Mandi Prices</button>
        <button data-page="buyer" class="nav-btn hover:text-green-700" data-translate="nav_buyer">Buyer Connect</button>
        <button data-page="advisory" class="nav-btn hover:text-green-700" data-translate="nav_advisory">Advisory</button>
        <button data-page="schemes" class="nav-btn hover:text-green-700" data-translate="nav_schemes">Schemes</button>`;

                if (currentUser) {
                    navHTML += `<button data-page="my-posts" class="nav-btn hover:text-green-700">My Posts</button>`;
                    if (currentUser.role === 'admin') {
                        navHTML += `<button data-page="admin" class="nav-btn bg-red-100 text-red-700 px-2 py-1 rounded hover:bg-red-200">Admin Panel</button>`;
                    }
                }

                // --- 2. Render the complete navigation bar to the DOM once ---
                mainNavLinks.innerHTML = navHTML;

                // --- 3. Update the auth links (Login/Register or Welcome/Logout) ---
                if (currentUser) {
                    authLinksContainer.innerHTML = `
            <span class="font-medium text-gray-700">
                <span data-translate="welcome_user">Welcome</span>, ${currentUser.name} (${currentUser.role})
            </span>
            <button id="logout-btn" class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 text-sm">Logout</button>`;
                    document.getElementById('logout-btn').addEventListener('click', handleLogout);
                } else {
                    authLinksContainer.innerHTML = `
            <button id="login-btn" class="text-gray-600 hover:text-green-700 font-medium">Login</button>
            <button id="register-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">Register</button>`;
                    document.getElementById('login-btn').addEventListener('click', () => openModal('login-modal'));
                    document.getElementById('register-btn').addEventListener('click', () => openModal('register-modal'));
                }

                // --- 4. Re-apply event listeners and update visibility of other page sections ---
                document.querySelectorAll('.nav-btn').forEach(button => {
                    button.addEventListener('click', () => showPage(button.dataset.page));
                });

                document.getElementById('buyer-form-section').style.display = currentUser?.role === 'buyer' ? 'block' : 'none';
                document.getElementById('buyer-login-prompt').style.display = currentUser ? 'none' : 'block';
                document.getElementById('farmer-form-section').style.display = currentUser?.role === 'farmer' ? 'block' : 'none';
                document.getElementById('farmer-login-prompt').style.display = currentUser ? 'none' : 'block';
                document.getElementById('admin-price-update-section').style.display = currentUser?.role === 'admin' ? 'block' : 'none';

                // --- 5. Re-apply the current language to all new elements ---
                setLanguage(languageSwitcher.value);

                // --- 6. CRUCIAL FIX: Re-fetch content that depends on login state ---
                fetchBuyerRequests();
                fetchFarmerListings();
            };

            // REPLACE your old updateUIForAuthState function with this one
            const checkAuthStatus = async () => {
                try {
                    const response = await fetch('/api/auth/status');
                    const data = await response.json();
                    currentUser = data.loggedIn ? data.user : null;
                } catch (error) {
                    console.error("Auth check failed:", error);
                    currentUser = null;
                }
                updateUIForAuthState();
            };

            // ADD THIS HELPER FUNCTION to your script
            const formatDate = (dateString) => {
                if (!dateString) return '';
                return new Date(dateString).toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });
            };
            // ... after checkAuthStatus function

            const getWeatherEmoji = (condition) => {
                switch (condition) {
                    case 'Clear': return '☀️';
                    case 'Clouds': return '☁️';
                    case 'Rain': return '🌧️';
                    case 'Drizzle': return '🌦️';
                    case 'Thunderstorm': return '⛈️';
                    case 'Snow': return '❄️';
                    case 'Mist':
                    case 'Fog':
                    case 'Haze':
                        return '🌫️';
                    default: return '🌡️';
                }
            };

            const fetchWeather = async (lat, lon) => {
                try {
                    const response = await fetch(`/api/weather?lat=${lat}&lon=${lon}`);
                    if (!response.ok) throw new Error('Failed to fetch');
                    const weather = await response.json();

                    document.getElementById('weather-location').textContent = `Today's Weather in ${weather.location}`;
                    document.getElementById('weather-content').innerHTML = `
            <div>
                <p class="text-5xl">${getWeatherEmoji(weather.condition)}</p>
                <p class="text-xl font-semibold">${Math.round(weather.temperature)}°C</p>
                <p class="text-gray-600">${weather.condition}</p>
            </div>
            <div>
                <p class="font-medium text-gray-700">Humidity: ${weather.humidity}%</p>
                <p class="font-medium text-gray-700">Wind: ${(weather.windSpeed * 3.6).toFixed(1)} km/h</p>
                <p class="font-medium text-gray-700">Precipitation: 5%</p> </div>
        `;
                    document.getElementById('weather-error').classList.add('hidden');

                } catch (error) {
                    console.error("Weather fetch error:", error);
                    document.getElementById('weather-location').textContent = `Today's Weather`;
                    document.getElementById('weather-content').classList.add('hidden');
                    document.getElementById('weather-error').classList.remove('hidden');
                }
            };


            // --- NEW: DYNAMIC CONTENT FETCHING ---
            const fetchNews = async () => {
                const response = await fetch('/api/news');
                const newsItems = await response.json();
                const container = document.getElementById('news-container');
                container.innerHTML = newsItems.length ? '' : '<p>No news updates at the moment.</p>';
                newsItems.forEach(item => {
                    container.innerHTML += `
                    <div class="p-4 bg-gray-50 rounded-lg border">
                        <h3 class="font-bold text-gray-800">${item.headline}</h3>
                        <p class="text-sm text-gray-600">${item.subtopic}</p>
                        <a href="${item.link}" target="_blank" class="text-sm text-blue-600 hover:underline">Read More &rarr;</a>
                    </div>`;
                });
            };

            const fetchSchemes = async () => {
                const response = await fetch('/api/schemes');
                const schemes = await response.json();
                const container = document.getElementById('schemes-container');
                container.innerHTML = schemes.length ? '' : '<p>No schemes to display.</p>';
                schemes.forEach(item => {
                    container.innerHTML += `
                    <div class="p-6 bg-yellow-50 rounded-lg border border-yellow-200">
                        <h3 class="font-bold text-lg text-yellow-800 mb-2">${item.title}</h3>
                        <p class="text-gray-700">${item.description}</p>
                        ${item.link ? `<a href="${item.link}" target="_blank" class="mt-2 inline-block text-blue-600 hover:underline font-semibold">Learn More &rarr;</a>` : ''}
                    </div>`;
                });
            };

            const fetchAdvisory = async () => {
                const response = await fetch('/api/advisory');
                const tips = await response.json();
                const container = document.getElementById('advisory-container');
                container.innerHTML = tips.length ? '' : '<p>No advisory tips available.</p>';
                tips.forEach(item => {
                    container.innerHTML += `
                    <div class="p-6 bg-green-50 rounded-lg border border-green-200">
                        <h3 class="font-bold text-lg text-green-800 mb-2">${item.title}</h3>
                        <p class="text-gray-700">${item.description}</p>
                    </div>`;
                });
            };

            // --- NEW: ADMIN PANEL LOGIC ---
            // --- ADD ALL OF THIS NEW JAVASCRIPT LOGIC ---

            // Function to fetch and render Farmer Listings
            const fetchFarmerListings = async () => {
                try {
                    const response = await fetch('/api/farmer-listings');
                    const listings = await response.json();
                    const container = document.getElementById('farmer-listings');
                    container.innerHTML = listings.length === 0 ? `<p class="text-gray-500">No produce listed for sale currently.</p>` : '';

                    // REPLACE the forEach loop in fetchFarmerListings
                    listings.forEach(listing => {
                        const isOwner = currentUser && currentUser.id === listing.farmerId.toString();
                        const isCompleted = listing.status === 'completed';

                        container.innerHTML += `
        <div class="card bg-gray-50 border ${isCompleted ? 'border-gray-300' : 'border-green-400'}">
             <div class="flex justify-between items-start">
                <div>
                    <h4 class="font-bold text-lg">${listing.crop} - ${listing.quantity} quintals</h4>
                    <p class="font-semibold text-green-700">Price: ₹${listing.price} / quintal</p>
                    <p class="text-sm text-gray-600">Posted by: ${listing.farmerName}</p>
                    ${!isCompleted ? `<p class="text-sm text-gray-600 font-medium">Contact: ${listing.contactNumber}</p>` : ''}
                </div>
                <span class="font-semibold px-3 py-1 text-sm rounded-full capitalize ${isCompleted ? 'bg-gray-200 text-gray-800' : 'bg-green-100 text-green-800'}">${isCompleted ? 'completed' : 'available'}</span>
            </div>

            ${isOwner ? `
            <div class="mt-4 pt-4 border-t">
                 ${isCompleted ? `
                <div class="text-xs text-gray-500">
                    <span>Posted: ${formatDate(listing.createdAt)}</span> | 
                    <span>Completed: ${formatDate(listing.completedAt)}</span>
                </div>
                ` : `
                <div class="flex gap-2">
                    <button data-id="${listing._id}" data-collection="farmer-listings" class="complete-btn flex-1 bg-green-500 text-white py-1 rounded hover:bg-green-600 text-sm">Mark as Complete</button>
                    <button data-id="${listing._id}" data-collection="farmer-listings" class="delete-btn flex-1 bg-red-500 text-white py-1 rounded hover:bg-red-600 text-sm">Delete</button>
                </div>
                `}
            </div>
            ` : ''}
        </div>
    `;
                    });


                } catch (error) {
                    console.error("Failed to fetch farmer listings:", error);
                }
            };

            // Function to fetch and render the user's own posts
            const fetchMyPosts = async () => {
                if (!currentUser) return;
                try {
                    const response = await fetch('/api/my-posts');
                    const posts = await response.json();
                    const container = document.getElementById('my-posts-container');
                    container.innerHTML = posts.length === 0 ? `<p class="text-gray-500">You have not posted anything yet.</p>` : '';

                    // REPLACE the entire posts.forEach loop inside fetchMyPosts
                    // REPLACE the forEach loop in fetchMyPosts
                    posts.forEach(post => {
                        const isCompleted = post.status === 'completed';
                        const isBuyerPost = !!post.buyerName;
                        const collection = isBuyerPost ? 'buyers' : 'farmer-listings';
                        let postHTML = '';

                        const completedView = `
        <div class="mt-2 pt-2 border-t text-xs text-gray-500">
            <span>Posted: ${formatDate(post.createdAt)}</span> | 
            <span>Completed: ${formatDate(post.completedAt)}</span>
        </div>`;

                        const openView = `
        <div class="mt-2 pt-2 border-t flex gap-2">
            <button data-id="${post._id}" data-collection="${collection}" class="complete-btn flex-1 bg-green-500 text-white py-1 rounded hover:bg-green-600 text-sm">Mark as Complete</button>
            <button data-id="${post._id}" data-collection="${collection}" class="delete-btn flex-1 bg-red-500 text-white py-1 rounded hover:bg-red-600 text-sm">Delete</button>
        </div>`;

                        if (isBuyerPost) {
                            postHTML = `
        <div class="p-4 border rounded-lg">
            <p class="text-sm text-gray-500">Your Buyer Request</p>
            <h4 class="font-bold text-lg">${post.crop} - ${post.quantity} quintals</h4>
            <span class="font-semibold px-2 py-0.5 text-xs rounded-full capitalize ${isCompleted ? 'bg-gray-200 text-gray-800' : 'bg-blue-100 text-blue-800'}">${post.status}</span>
            ${isCompleted ? completedView : openView}
        </div>`;
                        } else {
                            postHTML = `
        <div class="p-4 border rounded-lg">
            <p class="text-sm text-gray-500">Your Farmer Listing</p>
            <h4 class="font-bold text-lg">${post.crop} - ${post.quantity} quintals at ₹${post.price}/q</h4>
            <span class="font-semibold px-2 py-0.5 text-xs rounded-full capitalize ${isCompleted ? 'bg-gray-200 text-gray-800' : 'bg-green-100 text-green-800'}">${isCompleted ? 'completed' : 'available'}</span>
            ${isCompleted ? completedView : openView}
        </div>`;
                        }
                        container.innerHTML += postHTML;
                    });

                } catch (error) {
                    console.error("Failed to fetch my posts:", error);
                }
            };

            // Event listener for the new Farmer form
            document.getElementById('farmer-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const body = {
                    crop: e.target.elements['farmer-crop-input'].value,
                    quantity: e.target.elements['farmer-quantity-input'].value,
                    price: e.target.elements['farmer-price-input'].value,
                    contactNumber: e.target.elements['farmer-contact-input'].value
                };
                const response = await fetch('/api/farmer-listings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                if (response.ok) {
                    showNotification('Listing submitted successfully!');
                    e.target.reset();
                    fetchFarmerListings();
                } else {
                    showNotification('Failed to submit listing.');
                }
            });

            // Event delegation for deleting a listing from "My Posts" page
            // ADD THIS NEW, UNIFIED EVENT HANDLER
            // REPLACE your old handlePostActions function with this one
            const handlePostActions = async (e) => {
                const target = e.target;
                if (!target.dataset.id || !target.dataset.collection) return;

                const id = target.dataset.id;
                const collection = target.dataset.collection;

                // Handle "Mark as Complete"
                if (target.classList.contains('complete-btn')) {
                    showConfirmationModal('Are you sure you want to mark this post as completed?', async () => {
                        const response = await fetch(`/api/posts/${collection}/${id}/complete`, { method: 'PUT' });
                        if (response.ok) {
                            showNotification('Post marked as complete!');
                            fetchBuyerRequests(); fetchFarmerListings(); if (!document.getElementById('page-my-posts').classList.contains('hidden')) fetchMyPosts();
                        } else {
                            showNotification('Failed to update post.', 'error');
                        }
                    });
                }

                // Handle "Delete"
                if (target.classList.contains('delete-btn')) {
                    showConfirmationModal('Are you sure you want to permanently delete this post?', async () => {
                        const response = await fetch(`/api/${collection}/${id}`, { method: 'DELETE' });
                        if (response.ok) {
                            showNotification('Post deleted successfully!');
                            fetchBuyerRequests(); fetchFarmerListings(); if (!document.getElementById('page-my-posts').classList.contains('hidden')) fetchMyPosts();
                        } else {
                            showNotification('Failed to delete post.', 'error');
                        }
                    });
                }
            };

            document.getElementById('page-buyer').addEventListener('click', handlePostActions);
            document.getElementById('page-my-posts').addEventListener('click', handlePostActions);


            // Event listener for showing the "My Posts" page and fetching data
            document.addEventListener('click', e => {
                if (e.target && e.target.dataset.page === 'my-posts') {
                    fetchMyPosts();
                }
            });

            // Logic for the new tabs on the Buyer Connect page
            const tabs = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Style tabs
                    tabs.forEach(t => t.classList.remove('border-green-600', 'text-green-600'));
                    tab.classList.add('border-green-600', 'text-green-600');

                    // Show content
                    tabContents.forEach(c => c.classList.add('hidden'));
                    const contentId = `content-${tab.id.split('-')[1]}-${tab.id.split('-')[2]}`;
                    document.getElementById(contentId).classList.remove('hidden');
                });
            });

            // Generic function to render items in the admin panel
            const renderAdminList = async (endpoint, containerId, fields) => {
                const response = await fetch(endpoint);
                const items = await response.json();
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                items.forEach(item => {
                    container.innerHTML += `
                    <div class="flex justify-between items-center p-2 border-b">
                        <span>${item[fields[0]]}</span>
                        <button data-id="${item._id}" class="delete-btn text-red-500 hover:text-red-700 text-sm">Delete</button>
                    </div>`;
                });
            };

            // Function to load all data for the admin panel
            const loadAdminPanelData = () => {
                if (currentUser?.role === 'admin') {
                    renderAdminList('/api/news', 'admin-news-list', ['headline']);
                    renderAdminList('/api/schemes', 'admin-schemes-list', ['title']);
                    renderAdminList('/api/advisory', 'admin-advisory-list', ['title']);
                }
            };

            // Event listener for showing the admin page
            document.addEventListener('click', e => {
                if (e.target && e.target.dataset.page === 'admin') {
                    loadAdminPanelData();
                }
            });

            // ADD THIS NEW EVENT LISTENER to your main script

            // Generic function to handle form submissions for adding items
            const handleAddFormSubmit = async (e, endpoint, body, callback) => {
                e.preventDefault();
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                if (response.ok) {
                    e.target.reset();
                    callback(); // Reload the list
                } else {
                    showNotification('Action failed.', 'error')
                }
            };

            document.getElementById('add-news-form').addEventListener('submit', (e) => handleAddFormSubmit(e, '/api/news', {
                headline: document.getElementById('news-headline').value,
                subtopic: document.getElementById('news-subtopic').value,
                link: document.getElementById('news-link').value
            }, () => renderAdminList('/api/news', 'admin-news-list', ['headline'])));

            document.getElementById('add-scheme-form').addEventListener('submit', (e) => handleAddFormSubmit(e, '/api/schemes', {
                title: document.getElementById('scheme-title').value,
                description: document.getElementById('scheme-description').value,
                link: document.getElementById('scheme-link').value
            }, () => renderAdminList('/api/schemes', 'admin-schemes-list', ['title'])));

            document.getElementById('add-advisory-form').addEventListener('submit', (e) => handleAddFormSubmit(e, '/api/advisory', {
                title: document.getElementById('advisory-title').value,
                description: document.getElementById('advisory-description').value
            }, () => renderAdminList('/api/advisory', 'admin-advisory-list', ['title'])));


            // Event delegation for delete buttons
            document.getElementById('page-admin').addEventListener('click', async (e) => {
                if (e.target && e.target.classList.contains('delete-btn')) {
                    const id = e.target.dataset.id;
                    const listContainer = e.target.closest('.card').querySelector('[id^="admin-"]').id;
                    let endpoint = '';
                    if (listContainer.includes('news')) endpoint = `/api/news/${id}`;
                    if (listContainer.includes('schemes')) endpoint = `/api/schemes/${id}`;
                    if (listContainer.includes('advisory')) endpoint = `/api/advisory/${id}`;

                    if (confirm('Are you sure you want to delete this item?')) {
                        const response = await fetch(endpoint, { method: 'DELETE' });
                        if (response.ok) {
                            loadAdminPanelData(); // Refresh all lists
                        } else {
                            showNotification('Action failed.', 'error')
                        }
                    }
                }
            });


            // --- NEW: Image Carousel Logic ---
            const carouselItems = document.querySelectorAll('.carousel-item');
            let currentIndex = 0;
            let carouselInterval;

            const showSlide = (index) => {
                carouselItems.forEach((item, i) => {
                    item.classList.toggle('active', i === index);
                });
            };

            const nextSlide = () => {
                currentIndex = (currentIndex + 1) % carouselItems.length;
                showSlide(currentIndex);
            };

            const prevSlide = () => {
                currentIndex = (currentIndex - 1 + carouselItems.length) % carouselItems.length;
                showSlide(currentIndex);
            };

            const startCarousel = () => {
                carouselInterval = setInterval(nextSlide, 4000); // Change image every 4 seconds
            };

            const stopCarousel = () => clearInterval(carouselInterval);

            document.getElementById('next-btn').addEventListener('click', () => { stopCarousel(); nextSlide(); startCarousel(); });
            document.getElementById('prev-btn').addEventListener('click', () => { stopCarousel(); prevSlide(); startCarousel(); });

            const carouselElement = document.getElementById('image-carousel');
            carouselElement.addEventListener('mouseenter', stopCarousel);
            carouselElement.addEventListener('mouseleave', startCarousel);



            document.getElementById('register-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const body = { name: e.target.elements['register-name'].value, email: e.target.elements['register-email'].value, password: e.target.elements['register-password'].value, role: e.target.elements['register-role'].value };
                const response = await fetch('/api/auth/register', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                if (response.ok) { showNotification('Registration successful! Please log in.'); closeModal('register-modal'); openModal('login-modal'); } else { const err = await response.json(); showNotification(`Registration failed: ${err.message}`, 'error'); }
            });

            // REPLACE your old 'login-form' event listener with this one
            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                // Get the button and store its original text
                const loginBtn = document.getElementById('login-submit-btn');
                const originalBtnText = loginBtn.textContent;

                // --- Start loading state ---
                loginBtn.textContent = 'Logging in...';
                loginBtn.disabled = true;

                try {
                    const body = {
                        email: e.target.elements['login-email'].value,
                        password: e.target.elements['login-password'].value
                    };

                    const response = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });

                    if (response.ok) {
                        const data = await response.json();
                        currentUser = data.user;
                        closeModal('login-modal');
                        updateUIForAuthState();
                    } else {
                        showNotification('Login failed. Please check your credentials.', 'error');
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    showNotification('An unexpected error occurred.', 'error');
                } finally {
                    // --- End loading state (this runs on success or failure) ---
                    loginBtn.textContent = originalBtnText;
                    loginBtn.disabled = false;
                }
            });

            const handleLogout = async () => {
                await fetch('/api/auth/logout', { method: 'POST' });
                currentUser = null;         // Set user to null first
                updateUIForAuthState();     // THEN, update the screen
                showPage('home');           // Go back to the homepage
            };

            // --- MANdi PRICE LOGIC (CORRECTED) ---

            const displayMandiData = () => {
                const selectedState = document.getElementById('mandi-state').value;
                const selectedCrop = document.getElementById('mandi-crop').value;
                let filteredData = allMandiData;
                if (selectedState) {
                    filteredData = filteredData.filter(item => item.state === selectedState);
                }
                if (selectedCrop) {
                    filteredData = filteredData.filter(item => item.crop === selectedCrop);
                }
                const mandiDataBody = document.getElementById('mandi-data-body');

                mandiDataBody.innerHTML = '';
                filteredData.forEach(item => {
                    // REPLACE IT WITH THIS LINE
                    mandiDataBody.innerHTML += `<tr><td class="px-6 py-4">${item.crop} <span class="text-xs text-gray-500 italic">(${item.state})</span></td><td class="px-6 py-4 font-medium">₹ ${item.price}</td></tr>`;
                });
            };

            // NEW FUNCTION: To populate the crop dropdown based on the selected state
            const updateMandiFilters = () => {
                const selectedState = document.getElementById('mandi-state').value;
                const mandiCropSelect = document.getElementById('mandi-crop');

                const relevantData = selectedState ? allMandiData.filter(item => item.state === selectedState) : allMandiData;
                const crops = [...new Set(relevantData.map(item => item.crop))].sort();

                // Clear and repopulate the crop dropdown
                mandiCropSelect.innerHTML = '<option value="">All Crops</option>';
                crops.forEach(crop => {
                    mandiCropSelect.innerHTML += `<option value="${crop}">${crop}</option>`;
                });

                // After updating the filters, update the table
                displayMandiData();
            };

            // MODIFIED: This function now calls the new filter update function
            const fetchMandiData = async () => {
                try {
                    const response = await fetch('/api/mandi');
                    allMandiData = await response.json();
                    updateMandiFilters(); // This now correctly populates filters on initial load
                    populateAdminStateDropdown();
                } catch (error) {
                    console.error("Failed to fetch mandi data:", error);
                }
            };

            // --- NEW/MODIFIED: ADMIN PANEL LOGIC ---

            const adminStateSelect = document.getElementById('update-state');
            const adminCropSelect = document.getElementById('update-crop');
            const updatePriceForm = document.getElementById('update-price-form');

            const populateAdminStateDropdown = () => {
                adminStateSelect.innerHTML = '<option value="">-- Select State --</option>';
                indianStates.forEach(state => {
                    adminStateSelect.innerHTML += `<option value="${state}">${state}</option>`;
                });
            };

            // NEW: Function to populate the admin's crop dropdown based on state selection
            const updateAdminCropDropdown = () => {
                const selectedState = adminStateSelect.value;
                adminCropSelect.innerHTML = '<option value="">-- Select Crop --</option>';

                if (selectedState) {
                    const relevantData = allMandiData.filter(item => item.state === selectedState);
                    const crops = [...new Set(relevantData.map(item => item.crop))].sort();
                    crops.forEach(crop => {
                        adminCropSelect.innerHTML += `<option value="${crop}">${crop}</option>`;
                    });
                }
            };

            // NEW: Event listener for the admin state dropdown
            adminStateSelect.addEventListener('change', updateAdminCropDropdown);

            // NEW: Event listener to fix the form submission bug
            updatePriceForm.addEventListener('submit', async (e) => {
                e.preventDefault(); // This stops the page from reloading

                const body = {
                    state: adminStateSelect.value,
                    crop: adminCropSelect.value,
                    price: document.getElementById('update-price').value,
                };

                if (!body.state || !body.crop || !body.price) {
                    showNotification('Please fill out all fields.');
                    return;
                }

                try {
                    const response = await fetch('/api/mandi/update', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });

                    if (response.ok) {
                        showNotification('Price updated successfully!');
                        updatePriceForm.reset(); // Clear the form
                        adminCropSelect.innerHTML = '<option value="">-- Select a state first --</option>'; // Reset crop dropdown
                        fetchMandiData(); // Refresh the data in the table
                    } else {
                        const error = await response.json();
                        showNotification(`Update failed: ${error.message}`);
                    }
                } catch (error) {
                    console.error('Error updating price:', error);
                    showNotification('An error occurred. Please try again.');
                }
            });



            const fetchBuyerRequests = async () => {
                try {
                    const response = await fetch('/api/buyers');
                    const requests = await response.json();
                    const buyerRequestsDiv = document.getElementById('buyer-requests');
                    buyerRequestsDiv.innerHTML = requests.length === 0 ? `<p class="text-gray-500">No active requests found.</p>` : '';

                    // REPLACE the forEach loop in fetchBuyerRequests
                    requests.forEach(req => {
                        const isOwner = currentUser && currentUser.id === req.buyerId.toString();
                        const isCompleted = req.status === 'completed';

                        buyerRequestsDiv.innerHTML += `
    <div class="card bg-gray-50 border ${isCompleted ? 'border-gray-300' : 'border-blue-400'}">
        <div class="flex justify-between items-start">
            <div>
                <h4 class="font-bold text-lg">${req.crop} - ${req.quantity} quintals</h4>
                <p class="text-sm text-gray-600">Posted by: ${req.buyerName}</p>
                ${!isCompleted ? `<p class="text-sm text-gray-600 font-medium">Contact: ${req.contactNumber}</p>` : ''}
            </div>
            <span class="font-semibold px-3 py-1 text-sm rounded-full capitalize ${isCompleted ? 'bg-gray-200 text-gray-800' : 'bg-blue-100 text-blue-800'}">${req.status}</span>
        </div>
        
        ${isOwner ? `
        <div class="mt-4 pt-4 border-t">
            ${isCompleted ? `
            <div class="text-xs text-gray-500">
                <span>Posted: ${formatDate(req.createdAt)}</span> | 
                <span>Completed: ${formatDate(req.completedAt)}</span>
            </div>
            ` : `
            <div class="flex gap-2">
                <button data-id="${req._id}" data-collection="buyers" class="complete-btn flex-1 bg-green-500 text-white py-1 rounded hover:bg-green-600 text-sm">Mark as Complete</button>
                <button data-id="${req._id}" data-collection="buyers" class="delete-btn flex-1 bg-red-500 text-white py-1 rounded hover:bg-red-600 text-sm">Delete</button>
            </div>
            `}
        </div>
        ` : ''}
    </div>`;
                    });

                } catch (error) { console.error("Failed to fetch buyer requests:", error); }
            };

            document.getElementById('buyer-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const body = { crop: e.target.elements['buyer-crop-input'].value, quantity: e.target.elements['buyer-quantity-input'].value, contactNumber: e.target.elements['buyer-contact-input'].value };
                const response = await fetch('/api/buyers', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                if (response.ok) { showNotification('Request submitted successfully!'); e.target.reset(); fetchBuyerRequests(); } else { showNotification('Failed to submit request.'); }
            });

            const initializeApp = async () => {
                await checkAuthStatus();

                // ADD THIS BLOCK to get location and fetch weather
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const { latitude, longitude } = position.coords;
                            fetchWeather(latitude, longitude);
                        },
                        () => { // Error/denial case
                            console.error(`Geolocation error: ${error.message}`);
                            fetchWeather(25.5941, 85.1376); // Fallback to Patna, Bihar
                            console.log("Geolocation denied. Falling back to default location.");
                        }
                    );
                } else {
                    fetchWeather(19.0760, 72.8777); // Fallback for older browsers
                }

                const stateDropdowns = [document.getElementById('mandi-state'), document.getElementById('update-state')];

                stateDropdowns.forEach(select => {
                    select.innerHTML = '<option value="">All States</option>';
                    indianStates.forEach(state => {
                        select.innerHTML += `<option value="${state}">${state}</option>`;
                    });
                });

                // Fetch dynamic content for public pages
                fetchNews();
                fetchSchemes();
                fetchAdvisory();
                fetchMandiData();
                fetchBuyerRequests();
                fetchFarmerListings();


                // MODIFIED: The event listeners now call the correct functions
                document.getElementById('mandi-state').addEventListener('change', updateMandiFilters);
                document.getElementById('mandi-crop').addEventListener('change', displayMandiData);

                // Setup initial event listeners that don't depend on dynamic content
                document.querySelectorAll('.close-btn').forEach(btn => btn.addEventListener('click', () => closeModal(btn.dataset.modal)));

                // FIX: Add event listeners to static elements that are always on the page
                document.querySelectorAll('#page-home .clickable-tile').forEach(tile => {
                    tile.addEventListener('click', () => showPage(tile.dataset.page));
                });


                showPage('home');
                setLanguage(languageSwitcher.value); // Set initial language
                startCarousel(); // Start the carousel on load
            };

            initializeApp();
        });
    </script>
</body>

</html>